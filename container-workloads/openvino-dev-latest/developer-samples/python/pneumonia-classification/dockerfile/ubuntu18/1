

FROM devcloud_data_dev:2021.4_latest

RUN echo "OpenVINO installation done  ......."
RUN echo "Intel devcloud Sample containerization begin ......."

USER root
RUN apt-get  -y update
RUN apt-get install ffmpeg libsm6 libxext6 -y
RUN chmod 0777 ${INTEL_OPENVINO_DIR}/python

ADD  third-party-utils/Anaconda3-2019.03-Linux-x86_64.sh ${INTEL_OPENVINO_DIR}/python/samples/
RUN chmod 0755 ${INTEL_OPENVINO_DIR}/python/samples/Anaconda3-2019.03-Linux-x86_64.sh
RUN bash ${INTEL_OPENVINO_DIR}/python/samples/Anaconda3-2019.03-Linux-x86_64.sh -b && \
    echo "export PATH="/root/anaconda3/bin:$PATH"" >> ~/.bashrc && \
    /bin/bash -c "source ~/.bashrc"


RUN chmod 777 ${INTEL_OPENVINO_DIR}/deployment_tools/model_optimizer/install_prerequisites/install_prerequisites_caffe.sh
RUN chmod 777 ${INTEL_OPENVINO_DIR}/deployment_tools/model_optimizer/install_prerequisites/install_prerequisites.sh

RUN apt-get update && \
    apt-get autoremove -y dpkg-dev && \
    rm -rf /var/lib/apt/lists/*


RUN groupadd intel

ENV USERNAME=intel
ENV PASSWORD=intel
RUN useradd -m -p $(openssl passwd -1 ${PASSWORD}) -s /bin/bash -g sudo ${USERNAME}
RUN usermod -a -G  intel  intel

RUN mkdir -p  ${INTEL_OPENVINO_DIR}/python/samples

ADD developer-samples/python/ pneumonia-classification  ${INTEL_OPENVINO_DIR}/python/samples/pneumonia-classification

RUN chown -R  intel:intel  ${INTEL_OPENVINO_DIR} ${INTEL_OPENVINO_DIR}/python  ${INTEL_OPENVINO_DIR}/python/samples  ${INTEL_OPENVINO_DIR}/python/samples/pneumonia-classification ${INTEL_OPENVINO_DIR}/deployment_tools ${INTEL_OPENVINO_DIR}/deployment_tools/model_optimizer ${INTEL_OPENVINO_DIR}/deployment_tools/model_optimizer/install_prerequisites  /var/lib/dpkg

RUN chmod 777 ${INTEL_OPENVINO_DIR}/deployment_tools/model_optimizer/mo.py
RUN chmod -R 777 ${INTEL_OPENVINO_DIR}/python/samples/
RUN chmod 777 ${INTEL_OPENVINO_DIR}/python/samples/pneumonia-classification/*.sh
#RUN apt-get install ffmpeg libsm6 libxext6 -y

USER intel


#RUN bash ${INTEL_OPENVINO_DIR}/python/samples/Anaconda3-2019.03-Linux-x86_64.sh -b

#Set path to conda
#ENV PATH /home/intel/anaconda3/bin:$PATH
#ENV PATH ${INTEL_OPENVINO_DIR}/python/samples:$PATH



#ADD  third-party-utils/qarpo  ${INTEL_OPENVINO_DIR}/python/samples/qarpo

#ADD  third-party-utils/application_metrics_writer-0.1-py2.py3-none-any.whl ${INTEL_OPENVINO_DIR}/python/samples/


ARG DEVICE="CPU"
ENV DEVICE=$DEVICE

ARG PRECISION="FP16,FP32"
ENV PRECISION="$PRECISION"

ARG OPENVINO_VERSION="2021.3.394"
ENV OPENVINO_VERSION=$OPENVINO_VERSION


ARG OUTPUT_FOLDER="output_obj_det_latest"
ENV OUTPUT_FOLDER=$OUTPUT_FOLDER


ARG SUPPORTED_HW="CPU_TDP_70_205W"
ENV SUPPORTED_HW=$SUPPORTED_HW


RUN pip install ${INTEL_OPENVINO_DIR}/python/samples/qarpo/qarpo-1.0.30-py3-none-any.whl
RUN pip install ${INTEL_OPENVINO_DIR}/python/samples/qarpo/application_metrics_writer-0.1-py2.py3-none-any.whl
RUN pip install --upgrade protobuf==3.6.1
RUN pip install test-generator==0.1.1
RUN pip install tensorflow==1.15.2
RUN conda install -c menpo opencv


RUN source  ${INTEL_OPENVINO_DIR}/bin/setupvars.sh
RUN echo "Generating OpenVINO IR files ......."
RUN echo "Executing object detection app using OpenVINO ......."
WORKDIR ${INTEL_OPENVINO_DIR}/python/samples/pneumonia-classification
ENTRYPOINT /bin/bash -c "source ${INTEL_OPENVINO_DIR}/python/samples/pneumonia-classification/run_pneumonia.sh"

